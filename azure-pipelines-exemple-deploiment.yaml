trigger:
  branches:
    include:
      - main

# Variables globales
variables:
  buildConfiguration: 'Release'
  webAppName: 'my-webapp-prod'
  azureSubscription: 'ServiceConnectionName'   # Nom du service connection Azure DevOps

stages:

# ------------------------
#       BUILD STAGE
# ------------------------
- stage: Build
  displayName: "Build Application"
  jobs:
  - job: BuildJob
    displayName: "Build & Publish App"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: NodeTool@0
        displayName: "Use Node 18"
        inputs:
          versionSpec: '18.x'

      - script: |
          npm install
          npm run build
        displayName: "Build app"

      - task: CopyFiles@2
        displayName: "Copy files to artifact staging"
        inputs:
          SourceFolder: '$(System.DefaultWorkingDirectory)'
          Contents: '**/*'
          TargetFolder: '$(Build.ArtifactStagingDirectory)'

      - task: PublishBuildArtifacts@1
        displayName: "Publish artifact"
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'

# ------------------------
#     DEPLOYMENT STAGE
# ------------------------
- stage: Deploy
  displayName: "Deploy to Production"
  dependsOn: Build
  condition: succeeded()

  jobs:
  - deployment: DeployWebApp
    displayName: "Deploy to Azure Web App"
    environment: "production"          # Cr√©era automatiquement un environnement Azure DevOps
    strategy:
      runOnce:
        deploy:
          steps:

            - download: current
              artifact: drop

            - task: AzureWebApp@1
              displayName: "Deploy to Azure Web App"
              inputs:
                azureSubscription: "$(azureSubscription)"
                appName: "$(webAppName)"
                package: "$(Pipeline.Workspace)/drop"
